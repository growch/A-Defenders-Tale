package model {	import com.greensock.loading.SWFLoader;	import com.neriksworkshop.lib.ASaudio.Track;		import flash.display.MovieClip;	import flash.events.ErrorEvent;	import flash.events.Event;	import flash.events.EventDispatcher;	import flash.events.IOErrorEvent;	import flash.net.SharedObject;	import flash.net.URLLoader;	import flash.net.URLRequest;	import flash.net.registerClassAlias;	import flash.system.LoaderContext;		import control.EventController;	import control.GoViralService;	import control.StoreKitService;	import control.Twitter;		import events.ApplicationEvent;		import util.StringUtil;
	/**	 * @author Mark Grochowski	 */	public class DataModel extends EventDispatcher	{				//Singleton instance		private static var inst : DataModel;		//path to application configuration  file		//this is the default value in case no value is passed through flashvars		public static var MAINAPPPATH : String = "";		public static var XML_DIR : String = "xml/";		public static var APPDATAURL : String = "config.xml"; 		public static var ALLOWDOWNLOAD : Boolean = true;		public static var APPLICATIONNAME : String = "";		public static var trackInfo : Object;				private static var sharedObject:SharedObject;				public static var unlocked:Boolean;				public static var resMultiplier:int = 1;				public static var highRes:Boolean;				public static const APP_WIDTH:int = 768*resMultiplier;		public static const APP_HEIGHT:int = 1024*resMultiplier;				//application data object		public static var appData: ApplicationInfo;				public static var defenderInfo: DefenderApplicationInfo;		public static var defenderOptions : DefenderOptions = new DefenderOptions();				public static var storeKitService: StoreKitService;		public static var goViralService: GoViralService;		public static var twitter:Twitter;				private var _loader:URLLoader;				private var _cntr : Number = 0;				/** The list of loading methods, used to check if we fire onApplicationDataLoaded event. **/		private const _loadingMethods : Array = [ "onApplicationDataLoaded"];		public static const SOCIAL_FACEBOOK:String = "Facebook";		public static const SOCIAL_TWITTER:String = "Twitter";				public static var PAGE_ARRAY:Array = [];		public static var CURRENT_PAGE_ID : String = "";		public static var GOD_MODE : Boolean;		public static var CURRENT_ISLAND_INT: int;		public static var ISLANDS: Array = ["The Cattery", "The Joyless Mountains", "Shipwreck Cove", "The Sandlands", "The Capitol"];		public static var ISLAND_NAMESPACE: Array = ["theCattery", "joylessMountains", "shipwreck", "sandlands", "capitol"];		public static var ISLAND_SELECTED: Array = [];		public static var WEAPON_SOUND_ARRAY:Array = ["assets/audio/global/Dagger.mp3","assets/audio/global/Quill.mp3","assets/audio/global/Spells.mp3"];		public static var COMPANION_SOUND_ARRAY:Array = ["assets/audio/global/Ostrich.mp3","assets/audio/global/Lizard.mp3","assets/audio/global/Goldfish.mp3"];		public static var INSTRUMENT_SOUND_ARRAY:Array = ["assets/audio/global/Kazoo.mp3","assets/audio/global/Flute.mp3","assets/audio/global/Guitar.mp3"];		public static var BALLAD_SOUND_ARRAY:Array = ["assets/audio/global/BalladKazoo.mp3","assets/audio/global/BalladFlute.mp3","assets/audio/global/BalladGuitar.mp3"];		public static var JIG_SOUND_ARRAY:Array = ["assets/audio/joyless/joyless_jig_kazoo.mp3","assets/audio/joyless/joyless_jig_flute.mp3","assets/audio/flute/joyless_jig_guitar.mp3"];		//MIGHT NEED TO RESET ON RESTART/MAP		public static var SOCIAL_PLATFROM: String;		public static var SOCIAL_CONNECTED: Boolean = false;		public static var COMPANION_TAKEN: Boolean = false;		public static var STONE_COUNT: int = 0;		public static var STONE_CAT: Boolean = false;		public static var STONE_PEARL: Boolean = false;		public static var STONE_SAND: Boolean = false;		public static var STONE_SERPENT: Boolean = false;		//MIGHT NEED TO RESET ON RESTART/MAP		public static var coinCount:int;		public static var captainBattled:Boolean;		public static var thirdDoor:Boolean;		public static var bleujeanna:Boolean;		public static var climbDone:Boolean;		public static var escalator1:Boolean;		public static var impatience3:Boolean;		public static var rally:Boolean;		public static var supplies:Boolean;		public static var smegTalk:Boolean;		public static var sandpit:Boolean;		public static var well:Boolean;		public static var sand5Ft:Boolean;		public static var dropsCorrect:Boolean;		public static var companionSelected:Boolean;				public static var BOP_MICE_FPS:int = 44;		//IMPORTANT CUZ IPAD1 DOESN'T PERFORM VERY WELL		public static var ipad1:Boolean;		private var _swfLoader:SWFLoader;		public static var LoadContext:LoaderContext;		private var _btnTapSound:Track;		private var _endSound:Track;		private var _companionSound:Track;		private var _weaponSound:Track;		private var _instrumentSound:Track;		private var _oceanSound:Track;		private var _happilySound:Track;				public var networkConnected:Boolean;				public var navigationPeeked:Boolean;				public var contentsPageSelected:Boolean;				/**		 * contructor.		 * 		 * @return nothing		 */			public function DataModel():void		{		}				/**		 * singleton.		 * 		 * @return instance of DataLoader		 */			public static function getInstance():DataModel{			if( inst == null ) inst = new DataModel();			return inst;		}			public function loadApplicationConfigurationFile():void		{			_loader = new URLLoader();			_loader.addEventListener( Event.COMPLETE, onApplicationDataLoaded );			_loader.addEventListener(IOErrorEvent.IO_ERROR, errorLoadingAppData );			_loader.load(new URLRequest( XML_DIR+APPDATAURL ));		}				private function errorLoadingAppData(e : ErrorEvent) : void 		{			dispatchEvent(new ApplicationEvent(ApplicationEvent.DISPLAY_ERROR, e.text));		}		/*public function loadTrackingFile():void		{			_loader = new URLLoader();			_loader.addEventListener( Event.COMPLETE, onTrackingDataLoaded );			_loader.load(new URLRequest( TRACKINGDATAURL ));			}		 * 		 */				private function onApplicationDataLoaded( e:Event ) : void		{			XML.ignoreWhitespace = true;			var xml:XML = new XML(e.target["data"]);						appData = ApplicationInfo.parseInfo( xml );			_loader.removeEventListener( Event.COMPLETE, onApplicationDataLoaded );			_loader.removeEventListener(IOErrorEvent.IO_ERROR, errorLoadingAppData );						// call the method to broadcast applicationDataLoaded event			applicationDataLoaded();			//			System.disposeXML(xml);			xml = null;		}				public function resetBookData():void		{			PAGE_ARRAY = [];			defenderInfo = null;			SOCIAL_PLATFROM = null;			SOCIAL_CONNECTED = false;			GOD_MODE = false;			CURRENT_PAGE_ID = "";			ISLAND_SELECTED = [];			STONE_COUNT = 0;			COMPANION_TAKEN =  false;			STONE_CAT = false;			STONE_PEARL = false;			STONE_SAND = false;			STONE_SERPENT = false;			coinCount = 0;			bleujeanna = false;			thirdDoor = false;			captainBattled = false; 			climbDone = false; 			escalator1 = false; 			impatience3 = false; 			rally = false; 			supplies = false; 			smegTalk = false; 			sandpit = false; 			well = false; 			sand5Ft = false; 			dropsCorrect = false;			companionSelected = false;			contentsPageSelected = false;						sharedObject.clear();						dispatchEvent(new ApplicationEvent(ApplicationEvent.RESTART_BOOK));		}				public function getHistory():void {			registerClassAlias("model.DefenderApplicationInfo", DefenderApplicationInfo);						sharedObject = SharedObject.getLocal("appHistory");						// check if the application has been loaded before. register needed classes			if (sharedObject.data.defenderInfo == null)			{							trace("NO DEFENDER!!!!");//				sharedObject.data.history = new Array();			}			//			trace("getHistory sharedObject.data.defenderInfo: "+sharedObject.data.defenderInfo);//			trace("sharedObject.data: "+sharedObject.data);		}				public function restoreHistory():void {			if (sharedObject.data.defenderInfo) {				defenderInfo = sharedObject.data.defenderInfo as DefenderApplicationInfo;				trace("restoreHistory ->>>>> defenderInfo? "+defenderInfo.defender);			}		}				public function saveHistory():void {			sharedObject.data.PAGE_ARRAY = PAGE_ARRAY;			sharedObject.data.defenderInfo = defenderInfo;			sharedObject.data.SOCIAL_PLATFROM = SOCIAL_PLATFROM;			sharedObject.data.SOCIAL_CONNECTED = SOCIAL_CONNECTED;			sharedObject.data.CURRENT_PAGE_ID = CURRENT_PAGE_ID;			sharedObject.data.ISLAND_SELECTED = ISLAND_SELECTED;			sharedObject.data.STONE_COUNT = STONE_COUNT;			sharedObject.data.COMPANION_TAKEN = COMPANION_TAKEN;			sharedObject.data.STONE_CAT = STONE_CAT;			sharedObject.data.STONE_PEARL = STONE_PEARL;			sharedObject.data.STONE_SAND = STONE_SAND;			sharedObject.data.STONE_SERPENT = STONE_SERPENT;			sharedObject.data.coinCount = coinCount;			sharedObject.data.bleujeanna = bleujeanna;			sharedObject.data.thirdDoor = thirdDoor;			sharedObject.data.captainBattled = captainBattled;			sharedObject.data.climbDone = climbDone;			sharedObject.data.escalator1 = escalator1;			sharedObject.data.impatience3 = impatience3;			sharedObject.data.rally = rally;			sharedObject.data.supplies = supplies;			sharedObject.data.smegTalk = smegTalk;			sharedObject.data.sandpit = sandpit;			sharedObject.data.well = well;			sharedObject.data.sand5Ft = sand5Ft;			sharedObject.data.dropsCorrect = dropsCorrect;			sharedObject.data.companionSelected = companionSelected;						sharedObject.flush();		}				public function checkUnlock():void {			unlocked = sharedObject.data.unlocked;			if (!unlocked) {				trace("book locked");			} else {				trace("book is UNLOCKED!!!");			}		}				public function unlockBook():void {			sharedObject.data.unlocked = true;			sharedObject.flush();			unlocked = true;		}		/*private function onTrackingDataLoaded ( event:Event ) : void		{			XML.ignoreWhitespace = true;			var xml:XML = new XML( event.target.data );						// Initialise tracking			trackingManager = TrackingManager.getInstance();			trackingManager.init( xml );						_loader.removeEventListener( Event.COMPLETE , onTrackingDataLoaded );						// call the method to broadcast applicationDataLoaded event			applicationDataLoaded();		}		 * 		 */				public function removeAllChildren(thisMC:MovieClip):void {//			trace("removeAllChildren");			while (thisMC.numChildren > 0) {//				trace(thisMC.getChildAt(0));				thisMC.removeChildAt(0);			}		}				private function applicationDataLoaded () : void		{			_cntr++;			if( _cntr == _loadingMethods.length )			{				dispatchEvent( new ApplicationEvent( ApplicationEvent.APP_DATA_LOADED ) );			}		}				public function networkConnection():Boolean		{			trace("checkConnection");			if (!networkConnected) {				EventController.getInstance().dispatchEvent(new ApplicationEvent(ApplicationEvent.NO_INTERNET));			}			return networkConnected;		}				public static function getGoViral():GoViralService{			if( goViralService == null ) goViralService = new GoViralService();			return goViralService;		}				public static function getStoreKit():StoreKitService{			if( storeKitService == null ) storeKitService = new StoreKitService();			return storeKitService;		}				public static function getTwitter():Twitter{			if( twitter == null ) twitter = new Twitter();			return twitter;		}				public function randomRange(min:Number, max:Number) : Number {			return ((Math.random()*(max-min)) + min); 		}				public function findMovieClips(thisMC:MovieClip) : void {			findMCKids(thisMC);//			NOT USED!!!		}				private function findMCKids(thisMC:MovieClip):void {			var mc:MovieClip;			trace("findMCKids thisMC: " + thisMC.name);			for (var i:int = 0; i < thisMC.numChildren; i++) 			{				if (thisMC.getChildAt(i) is MovieClip) {					mc = thisMC.getChildAt(i) as MovieClip;					if (mc.numChildren > 0) {						findMCKids(mc);					} else {						trace("found: "+mc.name);					}				}			}		}				public function setGraphicResolution(thisMC:MovieClip) : void {			thisMC.gotoAndStop(1);			if (highRes) { //set in ADefendersTale.as				thisMC.gotoAndStop(2);			} 		}				public function replaceVariableText(thisString:String) : String {			// +++ DICTIONARY ITEMS			var pronoun1:String = appData.dictionary.pronoun1[defenderInfo.gender];			if (StringUtil.contains(thisString, "[Pronoun1]")) { 				thisString = StringUtil.replace(thisString, "[Pronoun1]", StringUtil.ucFirst(pronoun1));			}			thisString = StringUtil.replace(thisString, "[pronoun1]", pronoun1);			//			var pronoun2:String = appData.dictionary.pronoun2[defenderInfo.gender];			if (StringUtil.contains(thisString, "[Pronoun2]")) {				thisString = StringUtil.replace(thisString, "[Pronoun2]", StringUtil.ucFirst(pronoun2));			}			thisString = StringUtil.replace(thisString, "[pronoun2]", pronoun2);			//			var pronoun3:String = appData.dictionary.pronoun3[defenderInfo.gender];			if (StringUtil.contains(thisString, "[Pronoun3]")) {				thisString = StringUtil.replace(thisString, "[Pronoun3]", StringUtil.ucFirst(pronoun3));			}			thisString = StringUtil.replace(thisString, "[pronoun3]", pronoun3);			//			var pronoun4:String = appData.dictionary.pronoun4[defenderInfo.gender];			if (StringUtil.contains(thisString, "[Pronoun4]")) {				thisString = StringUtil.replace(thisString, "[Pronoun4]", StringUtil.ucFirst(pronoun4));			}			thisString = StringUtil.replace(thisString, "[pronoun4]", pronoun4);						// +++ DEFENDER DETAILS							thisString = StringUtil.replace(thisString, "[defender]", defenderInfo.defender);			thisString = StringUtil.replace(thisString, "[Defender]", StringUtil.ucFirst(defenderInfo.defender));			thisString = StringUtil.replace(thisString, "[age]", defenderInfo.age);			thisString = StringUtil.replace(thisString, "[hair]", defenderInfo.hair);			thisString = StringUtil.replace(thisString, "[beverage]", defenderInfo.beverage);			thisString = StringUtil.replace(thisString, "[gender]", defenderOptions.genderArray[defenderInfo.gender]);			thisString = StringUtil.replace(thisString, "[genderSpoken]", defenderOptions.genderSpokenArray[defenderInfo.gender]);			thisString = StringUtil.replace(thisString, "[romantic]", defenderOptions.romanticArray[defenderInfo.romantic]);			thisString = StringUtil.replace(thisString, "[companion]", defenderOptions.companionArray[defenderInfo.companion]);			thisString = StringUtil.replace(thisString, "[companionName]", defenderOptions.companionNameArray[defenderInfo.companion]);			thisString = StringUtil.replace(thisString, "[instrument]", defenderOptions.instrumentArray[defenderInfo.instrument]);			thisString = StringUtil.replace(thisString, "[wardrobeLong]", defenderOptions.wardrobeLongArray[defenderInfo.wardrobe]);			thisString = StringUtil.replace(thisString, "[wardrobeShort]", defenderOptions.wardrobeShortArray[defenderInfo.wardrobe]);			thisString = StringUtil.replace(thisString, "[weapon]", defenderOptions.weaponArray[defenderInfo.weapon]);						// SOCIAL			thisString = StringUtil.replace(thisString, "[socialNetwork]", SOCIAL_PLATFROM);						// +++ COMPANION			var compGenderInt:int;			if (defenderInfo.companion == 0) {				compGenderInt = 1;			} else {				compGenderInt = 0;			}			var pronoun1G:String = appData.dictionary.pronoun1[compGenderInt];			if (StringUtil.contains(thisString, "[CompanionPronoun1]")) { 				thisString = StringUtil.replace(thisString, "[CompanionPronoun1]", StringUtil.ucFirst(pronoun1G));			}			thisString = StringUtil.replace(thisString, "[companionPronoun1]", pronoun1G);			//			var pronoun2G:String = appData.dictionary.pronoun2[compGenderInt];			if (StringUtil.contains(thisString, "[CompanionPronoun2]")) {				thisString = StringUtil.replace(thisString, "[CompanionPronoun2]", StringUtil.ucFirst(pronoun2G));			}			thisString = StringUtil.replace(thisString, "[companionPronoun2]", pronoun2G);			//			var pronoun3G:String = appData.dictionary.pronoun3[compGenderInt];			if (StringUtil.contains(thisString, "[CompanionPronoun3]")) {				thisString = StringUtil.replace(thisString, "[CompanionPronoun3]", StringUtil.ucFirst(pronoun3G));			}			thisString = StringUtil.replace(thisString, "[companionPronoun3]", pronoun3G);			//			var pronoun4G:String = appData.dictionary.pronoun4[compGenderInt];			if (StringUtil.contains(thisString, "[CompanionPronoun4]")) {				thisString = StringUtil.replace(thisString, "[CompanionPronoun4]", StringUtil.ucFirst(pronoun4G));			}			thisString = StringUtil.replace(thisString, "[companionPronoun4]", pronoun4G);						// +++ CONTACT			thisString = StringUtil.replace(thisString, "[contact]", defenderInfo.contact);						var contGenderInt:int = defenderInfo.contactGender;						pronoun1G = appData.dictionary.pronoun1[contGenderInt];			if (StringUtil.contains(thisString, "[ContactPronoun1]")) { 				thisString = StringUtil.replace(thisString, "[ContactPronoun1]", StringUtil.ucFirst(pronoun1G));			}			thisString = StringUtil.replace(thisString, "[contactPronoun1]", pronoun1G);						pronoun2G = appData.dictionary.pronoun2[contGenderInt];			if (StringUtil.contains(thisString, "[ContactPronoun2]")) {				thisString = StringUtil.replace(thisString, "[ContactPronoun2]", StringUtil.ucFirst(pronoun2G));			}			thisString = StringUtil.replace(thisString, "[contactPronoun2]", pronoun2G);						pronoun3G = appData.dictionary.pronoun3[contGenderInt];			if (StringUtil.contains(thisString, "[ContactPronoun3]")) {				thisString = StringUtil.replace(thisString, "[ContactPronoun3]", StringUtil.ucFirst(pronoun3G));			}			thisString = StringUtil.replace(thisString, "[contactPronoun3]", pronoun3G);						pronoun4G = appData.dictionary.pronoun4[contGenderInt];			if (StringUtil.contains(thisString, "[ContactPronoun4]")) {				thisString = StringUtil.replace(thisString, "[ContactPronoun4]", StringUtil.ucFirst(pronoun4G));			}			thisString = StringUtil.replace(thisString, "[contactPronoun4]", pronoun4G);						// +++ PREVIOUS DEFENDER			var pdRomInt:int = defenderInfo.romantic;			var pdName:String = defenderOptions.previousDefenderArray[pdRomInt];			if (StringUtil.contains(thisString, "[PreviousDefender]")) {				thisString = StringUtil.replace(thisString, "[PreviousDefender]", StringUtil.ucFirst(pdName));			}			thisString = StringUtil.replace(thisString, "[previousDefender]", pdName);						pronoun1G = appData.dictionary.pronoun1[pdRomInt];			if (StringUtil.contains(thisString, "[PreviousDefenderPronoun1]")) { 				thisString = StringUtil.replace(thisString, "[PreviousDefenderPronoun1]", StringUtil.ucFirst(pronoun1G));			}			thisString = StringUtil.replace(thisString, "[previousDefenderPronoun1]", pronoun1G);						pronoun2G = appData.dictionary.pronoun2[pdRomInt];			if (StringUtil.contains(thisString, "[PreviousDefenderPronoun2]")) {				thisString = StringUtil.replace(thisString, "[PreviousDefenderPronoun2]", StringUtil.ucFirst(pronoun2G));			}			thisString = StringUtil.replace(thisString, "[previousDefenderPronoun2]", pronoun2G);						pronoun3G = appData.dictionary.pronoun3[pdRomInt];			if (StringUtil.contains(thisString, "[PreviousDefenderPronoun3]")) {				thisString = StringUtil.replace(thisString, "[PreviousDefenderPronoun3]", StringUtil.ucFirst(pronoun3G));			}			thisString = StringUtil.replace(thisString, "[previousDefenderPronoun3]", pronoun3G);						pronoun4G = appData.dictionary.pronoun4[pdRomInt];			if (StringUtil.contains(thisString, "[PreviousDefenderPronoun4]")) {				thisString = StringUtil.replace(thisString, "[PreviousDefenderPronoun4]", StringUtil.ucFirst(pronoun4G));			}			thisString = StringUtil.replace(thisString, "[previousDefenderPronoun4]", pronoun4G);						var pdGender:String;			if (defenderInfo.age < "18") {				pdGender = defenderOptions.previousDefenderGenderChildArray[pdRomInt];			} else {				pdGender = defenderOptions.previousDefenderGenderAdultArray[pdRomInt];			}			if (StringUtil.contains(thisString, "[PreviousDefenderGender]")) {				thisString = StringUtil.replace(thisString, "[PreviousDefenderGender]", StringUtil.ucFirst(pdGender));			}			thisString = StringUtil.replace(thisString, "[previousDefenderGender]", pdGender);						return thisString;		}				public function buttonTap():void {			if (!_btnTapSound) {				_btnTapSound = new Track("assets/audio/global/Tap.mp3");			}			_btnTapSound.start();		}				public function endSound():void {			if (!_endSound) {				_endSound = new Track("assets/audio/global/TheEnd.mp3");			}			_endSound.start();		}				public function companionSound():void {			if (!_companionSound) {				_companionSound = new Track(COMPANION_SOUND_ARRAY[defenderInfo.companion]);				}			_companionSound.start();		}				public function weaponSound():void {			if (!_weaponSound) {				_weaponSound = new Track(WEAPON_SOUND_ARRAY[defenderInfo.weapon]);			}			_weaponSound.start();		}				public function instrumentSound():void {			if (!_instrumentSound) {				_instrumentSound = new Track(INSTRUMENT_SOUND_ARRAY[defenderInfo.instrument]);			}			_instrumentSound.start();		}				public function oceanLoop():void {			if (!_oceanSound) {				_oceanSound = new Track("assets/audio/global/Ocean.mp3");				_oceanSound.loop = true;				_oceanSound.fadeAtEnd = true;//				_oceanSound.volumeMultiplier = 6;			}			_oceanSound.start(true);		}				public function happilyEverAfterSound():void {			if (!_happilySound) {				_happilySound = new Track("assets/audio/capitol/capitol_VICTORY.mp3");//				_happilySound.loop = true;//				_happilySound.fadeAtEnd = true;			}			_happilySound.start();		}				public function ShuffleArray(input:Array):void 		{			for (var i:int = input.length-1; i >=0; i--)			{				var randomIndex:int = Math.floor(Math.random()*(i+1));				var itemAtIndex:Object = input[randomIndex];				input[randomIndex] = input[i];				input[i] = itemAtIndex;			}		}					}}